<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Predictor v17 AI - Enhanced Learning</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #0f172a; min-height: 100vh; padding: 20px; color: #e2e8f0; }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { font-size: 56px; margin-bottom: 15px; background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 20px rgba(245, 158, 11, 0.3)); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        h1 { font-size: 48px; font-weight: 800; background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; letter-spacing: -2px; }
        .version { color: #94a3b8; font-size: 14px; font-weight: 500; }
        .ai-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; font-size: 10px; font-weight: 700; margin-left: 8px; animation: pulse-glow 2s infinite; }
        .learning-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 9px; font-weight: 700; margin-left: 6px; animation: learning-pulse 1.5s infinite; }
        @keyframes learning-pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.05); } }
        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(20px); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 20px; padding: 25px; transition: all 0.3s ease; }
        .card:hover { border-color: rgba(245, 158, 11, 0.3); transform: translateY(-2px); }
        .ai-panel { background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 20px; padding: 25px; margin-bottom: 20px; }
        .training-status { text-align: center; padding: 20px; }
        .training-progress { width: 100%; height: 8px; background: rgba(30, 41, 59, 0.5); border-radius: 10px; overflow: hidden; margin: 15px 0; }
        .training-fill { height: 100%; background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%); transition: width 0.3s ease; }
        .learning-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .learning-stat { background: rgba(30, 41, 59, 0.3); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 10px; padding: 12px; text-align: center; }
        .learning-stat-label { font-size: 9px; color: #64748b; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .learning-stat-value { font-size: 18px; font-weight: 800; color: #8b5cf6; }
        .trading-panel { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%); border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 20px; padding: 25px; margin-bottom: 20px; }
        .trading-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-label { font-size: 11px; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .input-field { width: 100%; padding: 12px; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 10px; color: #e2e8f0; font-size: 16px; font-weight: 600; transition: all 0.3s ease; }
        .input-field:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        .leverage-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .leverage-btn { padding: 8px; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 8px; color: #94a3b8; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; }
        .leverage-btn:hover { border-color: #10b981; color: #10b981; }
        .leverage-btn.active { background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-color: #10b981; color: white; }
        .trade-btn { padding: 16px; border: none; border-radius: 12px; font-weight: 800; font-size: 16px; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; width: 100%; margin-top: 15px; }
        .trade-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
        .trade-btn.start { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .trade-btn.stop { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .trade-btn.train { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        .trading-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 20px; }
        .stat-box { background: rgba(30, 41, 59, 0.3); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 15px; text-align: center; }
        .stat-label { font-size: 10px; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 24px; font-weight: 800; }
        .stat-positive { color: #10b981; }
        .stat-negative { color: #ef4444; }
        .stat-neutral { color: #f59e0b; }
        .liquidation-warning { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 15px; margin-top: 15px; text-align: center; }
        .liquidation-warning.active { animation: pulse-warning 2s infinite; }
        @keyframes pulse-warning { 0%, 100% { box-shadow: 0 0 10px rgba(239, 68, 68, 0.3); } 50% { box-shadow: 0 0 30px rgba(239, 68, 68, 0.6); } }
        .price-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .price-card { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 16px; padding: 25px; text-align: center; position: relative; overflow: hidden; }
        .price-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #f59e0b 0%, #f97316 100%); }
        .price-label { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #94a3b8; font-weight: 600; margin-bottom: 12px; }
        .price-value { font-size: 36px; font-weight: 800; color: #f59e0b; margin-bottom: 8px; }
        .confidence-bar { margin-top: 12px; height: 6px; background: rgba(30, 41, 59, 0.3); border-radius: 10px; overflow: hidden; }
        .confidence-fill { height: 100%; background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%); transition: width 0.5s ease; }
        .confidence-text { font-size: 11px; color: #64748b; margin-top: 6px; }
        .pulse { width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block; margin-left: 8px; animation: pulse 2s infinite; box-shadow: 0 0 10px #10b981; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); } 50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.6); } }
        .chart-card { height: 400px; }
        .chart-container { position: relative; height: calc(100% - 45px); }
        .section-title { font-size: 14px; font-weight: 700; color: #e2e8f0; margin-bottom: 18px; display: flex; align-items: center; gap: 8px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .stat-item { background: rgba(30, 41, 59, 0.3); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 12px; padding: 18px; text-align: center; transition: all 0.3s ease; }
        .stat-item:hover { border-color: rgba(245, 158, 11, 0.3); transform: scale(1.05); }
        .trade-log { max-height: 300px; overflow-y: auto; }
        .trade-entry { background: rgba(30, 41, 59, 0.3); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 10px; padding: 12px; margin-bottom: 10px; font-size: 12px; }
        .trade-entry.profit { border-left: 3px solid #10b981; }
        .trade-entry.loss { border-left: 3px solid #ef4444; }
        .trade-entry.liquidated { border-left: 3px solid #dc2626; background: rgba(239, 68, 68, 0.05); }
        .controls { display: flex; gap: 12px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 10px; font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn:hover { transform: translateY(-2px); }
        .btn-export { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-reset { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; }
        .loading { text-align: center; padding: 100px 20px; }
        .spinner { border: 4px solid rgba(245, 158, 11, 0.1); border-top: 4px solid #f59e0b; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } .trading-stats { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">₿</div>
            <h1>BTC Predictor v17<span class="ai-badge">🧠 ENHANCED AI</span><span class="learning-badge">🔄 AUTO-LEARNING</span></h1>
            <div class="version">Enhanced LSTM • Adaptive Training • 60%+ Target</div>
        </div>
        <div id="loading" class="loading"><div class="spinner"></div><p style="color: #64748b;">Initializing Enhanced AI...</p></div>
        <div id="content" style="display: none;">
            <div class="ai-panel">
                <div class="section-title">🧠 Enhanced AI Status - Auto-Learning Active</div>
                <div class="training-status">
                    <div style="font-size: 14px; font-weight: 700; color: #8b5cf6; margin-bottom: 10px;" id="modelStatus">Collecting data...</div>
                    <div class="training-progress"><div class="training-fill" id="trainingProgress" style="width: 0%"></div></div>
                    <div style="font-size: 11px; color: #64748b;" id="trainingInfo">Need 100 data points for enhanced training</div>
                    <button id="trainBtn" class="trade-btn train" style="margin-top: 15px; display: none;">🚀 Train Enhanced AI</button>
                    <div class="learning-stats">
                        <div class="learning-stat"><div class="learning-stat-label">Retrain Cycles</div><div class="learning-stat-value" id="retrainCount">0</div></div>
                        <div class="learning-stat"><div class="learning-stat-label">Last Retrain</div><div class="learning-stat-value" style="font-size: 14px;" id="lastRetrain">--</div></div>
                        <div class="learning-stat"><div class="learning-stat-label">Next in</div><div class="learning-stat-value" style="font-size: 14px;" id="nextRetrain">--</div></div>
                    </div>
                </div>
            </div>
            <div class="trading-panel">
                <div class="section-title">💰 Paper Trading Control Panel</div>
                <div class="trading-controls">
                    <div class="input-group"><div class="input-label">Starting Balance ($)</div><input type="number" id="tradeAmount" class="input-field" value="1000" min="10" step="10"></div>
                    <div class="input-group"><div class="input-label">Leverage</div><div class="leverage-selector">
                        <button class="leverage-btn active" data-lev="1">1x</button><button class="leverage-btn" data-lev="2">2x</button><button class="leverage-btn" data-lev="5">5x</button><button class="leverage-btn" data-lev="10">10x</button><button class="leverage-btn" data-lev="20">20x</button><button class="leverage-btn" data-lev="50">50x</button><button class="leverage-btn" data-lev="75">75x</button><button class="leverage-btn" data-lev="100">100x</button>
                    </div></div>
                </div>
                <button id="startTrading" class="trade-btn start">🚀 Start AI Trading</button>
                <button id="stopTrading" class="trade-btn stop" style="display: none;">⏹️ Stop Trading</button>
                <div class="trading-stats">
                    <div class="stat-box"><div class="stat-label">Balance</div><div class="stat-value stat-neutral" id="currentBalance">$1000.00</div></div>
                    <div class="stat-box"><div class="stat-label">Live P&L</div><div class="stat-value stat-neutral" id="livePnL">$0.00</div><div style="font-size: 11px; color: #64748b; margin-top: 4px;" id="livePnLPercent">No Position</div></div>
                    <div class="stat-box"><div class="stat-label">Wins</div><div class="stat-value stat-positive" id="winCount">0</div></div>
                    <div class="stat-box"><div class="stat-label">Liquidations</div><div class="stat-value stat-negative" id="liqCount">0</div></div>
                </div>
                <div id="liquidationWarning" class="liquidation-warning" style="display: none;"><div style="font-size: 14px; font-weight: 700; color: #ef4444; margin-bottom: 5px;">⚠️ LIQUIDATION WARNING</div><div style="font-size: 12px; color: #fca5a5;">Price: <span id="liqPrice">--</span> | Distance: <span id="liqDistance">--</span>%</div></div>
            </div>
            <div class="main-grid">
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div class="price-section">
                        <div class="price-card"><div class="price-label">Current Price<span class="pulse"></span></div><div class="price-value" id="currentPrice">$--</div><div style="font-size: 11px; color: #64748b; margin-top: 8px;" id="lastUpdate">--</div><div class="badge" style="background: rgba(245,158,11,0.2); color: #f59e0b; border: 1px solid rgba(245,158,11,0.3);">⚡ PYTH</div></div>
                        <div class="price-card"><div class="price-label">AI Prediction</div><div class="price-value" id="predictedPrice">$--</div><div style="font-size: 18px; font-weight: 700; margin-top: 10px;" id="direction">--</div><div class="confidence-bar"><div class="confidence-fill" id="confidenceFill" style="width: 0%"></div></div><div class="confidence-text" id="confidenceText">Confidence: --</div><span id="regime" class="badge" style="background: rgba(139,92,246,0.2); color: #8b5cf6; border: 1px solid rgba(139,92,246,0.3);">🧠 ENHANCED</span><div style="font-size: 11px; color: #64748b; margin-top: 8px;" id="predictionTime">--</div></div>
                    </div>
                    <div class="card chart-card"><div class="section-title">📈 Prediction vs Actual</div><div class="chart-container"><canvas id="predictionChart"></canvas></div></div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div class="card"><div class="section-title">📊 Performance</div><div class="stats-grid">
                        <div class="stat-item"><div class="stat-label">Accuracy</div><div class="stat-value" id="accuracy">--%</div></div>
                        <div class="stat-item"><div class="stat-label">Predictions</div><div class="stat-value" id="totalPredictions">0</div></div>
                        <div class="stat-item"><div class="stat-label">Data Points</div><div class="stat-value" id="dataPoints">0</div></div>
                        <div class="stat-item"><div class="stat-label">Status</div><div class="stat-value" id="aiTrained" style="font-size: 16px;">🔄 Learning</div></div>
                    </div></div>
                    <div class="card"><div class="section-title">📊 Trade Log</div><div class="trade-log" id="tradeLog"><div style="text-align: center; color: #64748b; padding: 20px;">No trades yet.</div></div></div>
                </div>
            </div>
            <div class="controls">
                <button id="exportBtn" class="btn btn-export">📥 Export Data</button>
                <button id="resetBtn" class="btn btn-reset">🔄 Reset All</button>
            </div>
        </div>
    </div>
    <script>
        const PYTH_BTC_ID='0xe62df6c8b4a85fe1a67db44dc12de5db330f7ac66b72dc658afedf0f4a415b43';const PYTH_API_URL='https://hermes.pyth.network/api/latest_price_feeds';const UPDATE_INTERVAL=10000;const PREDICTION_WINDOW=5;const MIN_DATA_FOR_TRAINING=100;const MIN_CONFIDENCE_TO_TRADE=55;const RETRAIN_EVERY_N_PREDICTIONS=5;const MIN_ACCURACY_THRESHOLD=50;const RETRAIN_EPOCHS=30;const AUTO_RETRAIN_INTERVAL=20*60*1000;let history=[],predictions=[],evaluatedPredictions=[],chartData={labels:[],actual:[],predicted:[]},chart=null;let isTrading=false,startingBalance=1000,currentBalance=1000,leverage=1,position=null,winCount=0,liqCount=0,trades=[];let aiModel=null,modelTrained=false,isTraining=false;let retrainCount=0;let lastRetrainTime=null;let predictionsSinceRetrain=0;let continuousLearningActive=false;let nextAutoRetrain=null;document.querySelectorAll('.leverage-btn').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.leverage-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');leverage=parseInt(btn.dataset.lev);if(position)updateLiquidationWarning();});});document.getElementById('startTrading').addEventListener('click',startTrading);document.getElementById('stopTrading').addEventListener('click',stopTrading);document.getElementById('trainBtn').addEventListener('click',()=>trainAIModel(true));function startTrading(){if(!modelTrained){alert('⚠️ AI model not trained yet! Please wait for training to complete.');return;}startingBalance=parseFloat(document.getElementById('tradeAmount').value)||1000;currentBalance=startingBalance;isTrading=true;winCount=0;liqCount=0;trades=[];document.getElementById('startTrading').style.display='none';document.getElementById('stopTrading').style.display='block';document.getElementById('tradeAmount').disabled=true;updateTradingUI();}function stopTrading(){if(position)closePosition('Manual Stop');isTrading=false;document.getElementById('startTrading').style.display='block';document.getElementById('stopTrading').style.display='none';document.getElementById('tradeAmount').disabled=false;document.getElementById('liquidationWarning').style.display='none';}function calculateLiquidationPrice(entry,type,lev){if(lev===1)return type==='long'?0:999999999;const liqPercent=(1/lev)*0.9;return type==='long'?entry*(1-liqPercent):entry*(1+liqPercent);}function updateLiquidationWarning(){if(!position){document.getElementById('liquidationWarning').style.display='none';return;}const liqPrice=calculateLiquidationPrice(position.entry,position.type,position.leverage);const currentPrice=history[history.length-1];const distance=((liqPrice-currentPrice)/currentPrice)*100;document.getElementById('liqPrice').textContent='$'+liqPrice.toLocaleString('en-US',{minimumFractionDigits:2});document.getElementById('liqDistance').textContent=distance.toFixed(2);if(Math.abs(distance)<5){document.getElementById('liquidationWarning').style.display='block';document.getElementById('liquidationWarning').classList.add('active');}else if(Math.abs(distance)<10){document.getElementById('liquidationWarning').style.display='block';document.getElementById('liquidationWarning').classList.remove('active');}else{document.getElementById('liquidationWarning').style.display='none';}}function openPosition(type,entry){if(currentBalance<=0)return;const tradeAmount=currentBalance*0.95;position={type,entry,amount:tradeAmount,leverage,time:new Date()};updateLiquidationWarning();}function closePosition(reason,currentPrice=null){if(!position)return;currentPrice=currentPrice||history[history.length-1];const priceChange=((currentPrice-position.entry)/position.entry);const multiplier=position.type==='long'?1:-1;const pnlPercent=priceChange*multiplier*position.leverage;const pnl=position.amount*pnlPercent;currentBalance+=pnl;const trade={type:position.type,entry:position.entry,exit:currentPrice,leverage:position.leverage,pnl,pnlPercent:pnlPercent*100,reason,time:position.time,closeTime:new Date()};if(reason==='Liquidated'){currentBalance=0;liqCount++;trade.liquidated=true;}else if(pnl>0){winCount++;}trades.unshift(trade);if(trades.length>20)trades.pop();position=null;updateTradingUI();updateTradeLog();}function checkLiquidation(currentPrice){if(!position)return;const liqPrice=calculateLiquidationPrice(position.entry,position.type,position.leverage);if(position.type==='long'&&currentPrice<=liqPrice){closePosition('Liquidated',liqPrice);}else if(position.type==='short'&&currentPrice>=liqPrice){closePosition('Liquidated',liqPrice);}}function updateTradingUI(){document.getElementById('currentBalance').textContent='$'+currentBalance.toFixed(2);document.getElementById('currentBalance').className='stat-value '+(currentBalance>startingBalance?'stat-positive':currentBalance<startingBalance?'stat-negative':'stat-neutral');document.getElementById('winCount').textContent=winCount;document.getElementById('liqCount').textContent=liqCount;if(position&&history.length>0){const currentPrice=history[history.length-1];const priceChange=((currentPrice-position.entry)/position.entry);const multiplier=position.type==='long'?1:-1;const pnlPercent=priceChange*multiplier*position.leverage;const livePnL=position.amount*pnlPercent;document.getElementById('livePnL').textContent=(livePnL>=0?'+':'')+'$'+livePnL.toFixed(2);document.getElementById('livePnL').className='stat-value '+(livePnL>=0?'stat-positive':'stat-negative');document.getElementById('livePnLPercent').textContent=(position.type.toUpperCase()+' '+position.leverage+'x • '+(pnlPercent*100>=0?'+':'')+(pnlPercent*100).toFixed(2)+'%');}else{document.getElementById('livePnL').textContent='$0.00';document.getElementById('livePnL').className='stat-value stat-neutral';document.getElementById('livePnLPercent').textContent='No Position';}updateLiquidationWarning();}function updateTradeLog(){if(trades.length===0)return;const html=trades.map(t=>{const pnlClass=t.liquidated?'liquidated':(t.pnl>0?'profit':'loss');const emoji=t.liquidated?'💀':(t.pnl>0?'✅':'❌');return`<div class="trade-entry ${pnlClass}"><div style="display:flex;justify-content:space-between;margin-bottom:5px;"><span style="font-weight:700;">${emoji} ${t.type.toUpperCase()} ${t.leverage}x</span><span style="font-weight:700;color:${t.pnl>=0?'#10b981':'#ef4444'};">${t.pnl>=0?'+':''}$${t.pnl.toFixed(2)}</span></div><div style="font-size:11px;color:#64748b;">Entry: $${t.entry.toFixed(2)} → Exit: $${t.exit.toFixed(2)} (${t.pnlPercent>=0?'+':''}${t.pnlPercent.toFixed(2)}%)</div><div style="font-size:10px;color:#475569;margin-top:3px;">${t.reason} • ${t.closeTime.toLocaleTimeString()}</div></div>`;}).join('');document.getElementById('tradeLog').innerHTML=html;}
async function trainAIModel(isInitial=false){if(isTraining||history.length<MIN_DATA_FOR_TRAINING){if(!isInitial){console.log('Skipping retrain');return;}alert('Need '+MIN_DATA_FOR_TRAINING+' points. Have: '+history.length);return;}isTraining=true;document.getElementById('trainBtn').disabled=true;const statusPrefix=isInitial?'Initial training':'Retraining';document.getElementById('modelStatus').textContent=statusPrefix+'...';console.log('🔄 '+(isInitial?'Initial':'Retrain #'+(retrainCount+1)));try{const trainingData=isInitial?history:history.slice(-300);const data=normalizeDataEnhanced(trainingData);const seqLength=15;const X=[];const y=[];for(let i=0;i<=data.length-seqLength-1;i++){const seq=[];for(let j=0;j<seqLength;j++){seq.push([data[i+j]]);}X.push(seq);y.push([data[i+seqLength]]);}const xTensor=tf.tensor3d(X);const yTensor=tf.tensor2d(y);if(!aiModel||isInitial){aiModel=tf.sequential();aiModel.add(tf.layers.lstm({units:64,returnSequences:true,inputShape:[seqLength,1]}));aiModel.add(tf.layers.dropout({rate:0.3}));aiModel.add(tf.layers.lstm({units:64,returnSequences:true}));aiModel.add(tf.layers.dropout({rate:0.3}));aiModel.add(tf.layers.lstm({units:32,returnSequences:false}));aiModel.add(tf.layers.dropout({rate:0.2}));aiModel.add(tf.layers.dense({units:16,activation:'relu'}));aiModel.add(tf.layers.dense({units:1}));aiModel.compile({optimizer:tf.train.adam(0.002),loss:'meanSquaredError',metrics:['mae']});}const epochs=isInitial?50:RETRAIN_EPOCHS;await aiModel.fit(xTensor,yTensor,{epochs:epochs,batchSize:32,validationSplit:0.15,shuffle:true,callbacks:{onEpochEnd:(epoch,logs)=>{const progress=((epoch+1)/epochs)*100;document.getElementById('trainingProgress').style.width=progress+'%';document.getElementById('trainingInfo').textContent=`${statusPrefix} - Epoch ${epoch+1}/${epochs} - Loss: ${logs.loss.toFixed(4)}`;}},verbose:0});xTensor.dispose();yTensor.dispose();modelTrained=true;continuousLearningActive=true;retrainCount++;lastRetrainTime=Date.now();nextAutoRetrain=Date.now()+AUTO_RETRAIN_INTERVAL;predictionsSinceRetrain=0;const statusMsg=isInitial?'✅ Enhanced AI Trained!':'🔄 Retrained! (Cycle #'+retrainCount+')';document.getElementById('modelStatus').textContent=statusMsg;document.getElementById('trainingInfo').textContent='Auto-learning active • '+X.length+' sequences';document.getElementById('aiTrained').textContent='✅ Active';document.getElementById('aiTrained').style.color='#10b981';updateLearningStats();console.log('✅ Training done:',X.length,'sequences');}catch(error){console.error('Training error:',error);document.getElementById('modelStatus').textContent='❌ Failed';document.getElementById('trainingInfo').textContent='Error: '+error.message;if(isInitial)alert('Training failed: '+error.message);}finally{isTraining=false;document.getElementById('trainBtn').disabled=false;}}function shouldRetrain(){if(!modelTrained||!continuousLearningActive)return false;if(predictionsSinceRetrain>=RETRAIN_EVERY_N_PREDICTIONS){console.log('🔄 Retrain: '+predictionsSinceRetrain+' predictions');return true;}const correct=evaluatedPredictions.filter(p=>p.correct).length;const total=evaluatedPredictions.length;if(total>=8){const accuracy=(correct/total)*100;if(accuracy<MIN_ACCURACY_THRESHOLD){console.log('🔄 Retrain: low accuracy '+accuracy.toFixed(1)+'%');return true;}}if(nextAutoRetrain&&Date.now()>=nextAutoRetrain){console.log('🔄 Retrain: scheduled');return true;}return false;}function updateLearningStats(){document.getElementById('retrainCount').textContent=retrainCount;if(lastRetrainTime){const ago=Math.floor((Date.now()-lastRetrainTime)/1000);document.getElementById('lastRetrain').textContent=ago<60?ago+'s':Math.floor(ago/60)+'m';}if(nextAutoRetrain){const remaining=Math.floor((nextAutoRetrain-Date.now())/1000);if(remaining>0){document.getElementById('nextRetrain').textContent=remaining<60?remaining+'s':Math.floor(remaining/60)+'m';}else{document.getElementById('nextRetrain').textContent='Soon';}}}function normalizeDataEnhanced(data){const mean=data.reduce((a,b)=>a+b,0)/data.length;const variance=data.reduce((a,b)=>a+Math.pow(b-mean,2),0)/data.length;const std=Math.sqrt(variance)+0.0001;return data.map(val=>(val-mean)/std);}function denormalizeDataEnhanced(normalizedVal,originalData){const mean=originalData.reduce((a,b)=>a+b,0)/originalData.length;const variance=originalData.reduce((a,b)=>a+Math.pow(b-mean,2),0)/originalData.length;const std=Math.sqrt(variance);return(normalizedVal*std)+mean;}async function predictWithAI(currentPrice){if(!aiModel||!modelTrained||history.length<15)return null;try{const recentData=history.slice(-100);const normalizedHistory=normalizeDataEnhanced(recentData);const seqLength=15;const sequence=[];for(let i=0;i<seqLength;i++){sequence.push([normalizedHistory[normalizedHistory.length-seqLength+i]]);}const inputTensor=tf.tensor3d([sequence]);const prediction=aiModel.predict(inputTensor);const normalizedPred=await prediction.data();inputTensor.dispose();prediction.dispose();const predictedPrice=denormalizeDataEnhanced(normalizedPred[0],recentData);const confidence=calculateEnhancedConfidence(predictedPrice,currentPrice,recentData);predictionsSinceRetrain++;if(shouldRetrain()){setTimeout(()=>trainAIModel(false),2000);}return{price:predictedPrice,direction:predictedPrice>currentPrice?'UP ⬆️':'DOWN ⬇️',confidence:confidence,timestamp:Date.now(),targetTime:Date.now()+(PREDICTION_WINDOW*60*1000),source:'AI'};}catch(error){console.error('Prediction error:',error);return null;}}function calculateEnhancedConfidence(predicted,current,recentData){const percentDiff=Math.abs((predicted-current)/current)*100;const prices=recentData.slice(-20);const changes=[];for(let i=1;i<prices.length;i++){changes.push(Math.abs((prices[i]-prices[i-1])/prices[i-1])*100);}const avgVolatility=changes.reduce((a,b)=>a+b,0)/changes.length;let confidence=45;if(percentDiff>avgVolatility*0.5&&percentDiff<avgVolatility*2){confidence=70;}else if(percentDiff>avgVolatility*0.3&&percentDiff<avgVolatility*3){confidence=62;}else if(percentDiff>avgVolatility*0.1){confidence=55;}if(percentDiff>0.2)confidence+=5;if(percentDiff>0.4)confidence+=5;return Math.min(confidence,85);}function initChart(){const ctx=document.getElementById('predictionChart').getContext('2d');chart=new Chart(ctx,{type:'line',data:{labels:chartData.labels,datasets:[{label:'Actual Price',data:chartData.actual,borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.05)',borderWidth:3,tension:0.4,pointRadius:4,pointHoverRadius:6},{label:'AI Prediction',data:chartData.predicted,borderColor:'#8b5cf6',backgroundColor:'rgba(139,92,246,0.05)',borderWidth:3,borderDash:[8,4],tension:0.4,pointRadius:4,pointHoverRadius:6}]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#94a3b8',font:{size:12,weight:700},padding:15},position:'top'},tooltip:{backgroundColor:'rgba(15,23,42,0.95)',titleColor:'#f59e0b',bodyColor:'#e2e8f0',borderColor:'rgba(245,158,11,0.3)',borderWidth:1,padding:12,displayColors:true,callbacks:{label:function(context){return context.dataset.label+': $'+context.parsed.y.toLocaleString('en-US',{minimumFractionDigits:2});}}}},scales:{x:{ticks:{color:'#64748b',font:{size:10}}},y:{ticks:{color:'#64748b',font:{size:11},callback:v=>'$'+v.toLocaleString('en-US')}}}}});}function updateChart(actual,predicted){const time=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});chartData.labels.push(time);chartData.actual.push(actual);chartData.predicted.push(predicted||actual);if(chartData.labels.length>20){chartData.labels.shift();chartData.actual.shift();chartData.predicted.shift();}if(chart){try{chart.update('none');}catch(e){console.error('Chart update error:',e);}}}function evaluatePredictions(curr){const now=Date.now(),windowMs=PREDICTION_WINDOW*60*1000;predictions=predictions.filter(pred=>{if(now-pred.timestamp>=windowMs){const actDir=curr>pred.currentPrice?'up':'down';const predDir=pred.price>pred.currentPrice?'up':'down';const correct=actDir===predDir;evaluatedPredictions.push({correct,timestamp:pred.timestamp,confidence:pred.confidence});if(evaluatedPredictions.length>100)evaluatedPredictions.shift();return false;}return true;});}async function fetchBTCPrice(){const r=await fetch(`${PYTH_API_URL}?ids[]=${PYTH_BTC_ID}`);const d=await r.json();if(d&&d[0]&&d[0].price){const p=d[0].price;return{price:parseFloat(p.price)*Math.pow(10,p.expo),timestamp:Date.now()};}throw new Error('Invalid');}function updateAIStatus(){const dataProgress=(history.length/MIN_DATA_FOR_TRAINING)*100;document.getElementById('trainingProgress').style.width=Math.min(dataProgress,100)+'%';if(modelTrained){updateLearningStats();}else if(history.length>=MIN_DATA_FOR_TRAINING&&!isTraining){document.getElementById('trainBtn').style.display='block';document.getElementById('modelStatus').textContent='✅ Ready for training!';document.getElementById('trainingInfo').textContent=`${history.length} points - Click to train`;}else if(history.length<MIN_DATA_FOR_TRAINING){document.getElementById('modelStatus').textContent=`Collecting... (${history.length}/${MIN_DATA_FOR_TRAINING})`;document.getElementById('trainingInfo').textContent='Gathering data for optimal training...';}}function updateUI(priceData,prediction){const price=priceData.price;document.getElementById('currentPrice').textContent=`$${price.toLocaleString('en-US',{minimumFractionDigits:2})}`;document.getElementById('lastUpdate').textContent=`Updated: ${new Date().toLocaleTimeString()}`;document.getElementById('dataPoints').textContent=history.length;updateChart(price,prediction?prediction.price:null);if(prediction){document.getElementById('predictedPrice').textContent=`$${prediction.price.toLocaleString('en-US',{minimumFractionDigits:2})}`;document.getElementById('predictionTime').textContent=`For ${new Date(prediction.targetTime).toLocaleTimeString()}`;document.getElementById('direction').textContent=prediction.direction;document.getElementById('direction').style.color=prediction.direction.includes('UP')?'#10b981':'#ef4444';const confPercent=prediction.confidence;document.getElementById('confidenceFill').style.width=confPercent+'%';document.getElementById('confidenceText').textContent=`Confidence: ${confPercent.toFixed(0)}%`;if(isTrading&&currentBalance>0&&confPercent>=MIN_CONFIDENCE_TO_TRADE){if(!position){const type=prediction.direction.includes('UP')?'long':'short';openPosition(type,price);}else{const shouldClose=(position.type==='long'&&prediction.direction.includes('DOWN'))||(position.type==='short'&&prediction.direction.includes('UP'));if(shouldClose){closePosition('AI Signal Change',price);const newType=prediction.direction.includes('UP')?'long':'short';if(currentBalance>0)openPosition(newType,price);}}}}const correct=evaluatedPredictions.filter(p=>p.correct).length;const total=evaluatedPredictions.length;const accuracy=total>0?(correct/total*100):0;document.getElementById('accuracy').textContent=accuracy.toFixed(1)+'%';document.getElementById('totalPredictions').textContent=total;if(isTrading&&position){checkLiquidation(price);updateTradingUI();}updateAIStatus();}async function update(){try{const priceData=await fetchBTCPrice();if(priceData&&priceData.price){const price=priceData.price;history.push(price);if(history.length>1000)history.shift();evaluatePredictions(price);let prediction=null;if(modelTrained){prediction=await predictWithAI(price);if(prediction)predictions.push({...prediction,currentPrice:price});}updateUI(priceData,prediction);document.getElementById('loading').style.display='none';document.getElementById('content').style.display='block';if(history.length>=MIN_DATA_FOR_TRAINING&&!modelTrained&&!isTraining){const shouldAsk=localStorage.getItem('btc-v17-train-asked');if(!shouldAsk){localStorage.setItem('btc-v17-train-asked','true');setTimeout(()=>{if(confirm('🧠 Enhanced AI Ready!\n\n'+history.length+' points collected.\n\nStart enhanced training?')){trainAIModel(true);}},3000);}}}}catch(error){console.error('Update error:',error);}}function exportData(){const correct=evaluatedPredictions.filter(p=>p.correct).length;const total=evaluatedPredictions.length;const data={metadata:{version:"17.0 Enhanced",exportDate:new Date().toISOString()},history,predictions,evaluatedPredictions,trades,trading:{currentBalance,winCount,liqCount,startingBalance,leverage},aiStatus:{trained:modelTrained,dataPoints:history.length,retrainCount,lastRetrainTime,continuousLearningActive},performance:{total,correct,accuracy:total>0?(correct/total*100).toFixed(2)+'%':'0%'}};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`btc-v17-${Date.now()}.json`;a.click();URL.revokeObjectURL(url);}function resetAll(){if(confirm('⚠️ Reset everything?\n\nDelete all data, AI model, and trading history?\n\nContinue?')){history=[];predictions=[];evaluatedPredictions=[];chartData={labels:[],actual:[],predicted:[]};trades=[];winCount=0;liqCount=0;currentBalance=startingBalance;retrainCount=0;lastRetrainTime=null;predictionsSinceRetrain=0;continuousLearningActive=false;nextAutoRetrain=null;if(aiModel){aiModel.dispose();aiModel=null;}modelTrained=false;localStorage.removeItem('btc-v17');localStorage.removeItem('btc-v17-train-asked');setTimeout(()=>location.reload(),500);}}document.getElementById('exportBtn').addEventListener('click',exportData);document.getElementById('resetBtn').addEventListener('click',resetAll);setTimeout(()=>{if(document.getElementById('content').style.display!=='none'){try{initChart();}catch(e){console.error('Chart error:',e);setTimeout(()=>initChart(),1000);}}},500);update();setInterval(update,UPDATE_INTERVAL);
    </script>
</body>
</html>
